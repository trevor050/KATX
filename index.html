<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Add meta tag to help with animation performance -->
  <meta name="theme-color" content="#131820">
  <title>KATX - Community Value Index</title>
  <link rel="stylesheet" href="style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Anime.js for Animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body class="mobile-ready">
  <canvas id="particle-canvas"></canvas>

  <header id="main-header">
    <div class="logo">K<span class="logo-accent-a">A</span><span class="logo-accent-t">T</span> <span class="logo-accent-x">X</span></div>
    <nav>
      <button data-section="info-hub" class="nav-button active">
        <i class="fa-solid fa-compass nav-icon"></i>
        Info Hub
      </button>
      <button data-section="value-database" class="nav-button">
        <i class="fa-solid fa-database nav-icon"></i>
        Value Database
      </button>
      <button data-section="guide" class="nav-button">
        <i class="fa-solid fa-book-open nav-icon"></i>
        Guide
      </button>
      <button data-section="update-log" class="nav-button">
        <i class="fa-solid fa-timeline nav-icon"></i>
        Update Log
      </button>
    </nav>
  </header>

  <main id="main-content">
    <!-- Section: Info Hub -->
    <section id="info-hub" class="content-section active">
      <div class="nexus-visual-container">
        <div class="nexus-element-v3">
          <div class="ring ring1"></div>
          <div class="ring ring2"></div>
          <div class="ring ring3"></div>
          <div class="core-glow"></div>
        </div>
        <div class="info-node-container"></div>
      </div>
      <div class="nexus-text-content">
        <h1 class="nexus-title">Community Value Index</h1>
        <p class="nexus-subtitle">Real-time insights into the KAT X item economy.</p>
        <button class="cta-button" id="nexus-cta-button" data-target-section="value-database">
          ACCESS DATABASE <i class="fa-solid fa-arrow-right arrow"></i>
        </button>
      </div>
    </section>

    <!-- Section: Value Database -->
    <section id="value-database" class="content-section">
      <h2><i class="fa-solid fa-database"></i> Value Database: Item Index</h2>
      <div class="armory-controls">
        <div class="control-group search-group">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input type="text" id="search-bar" placeholder="Search items...">
        </div>
        <div class="control-group filter-group">
          <label for="rarity-filter"><i class="fa-solid fa-gem"></i> Rarity:</label>
          <select id="rarity-filter"><option value="all">All</option></select>
        </div>
        <div class="control-group filter-group">
          <label for="obtainability-filter"><i class="fa-solid fa-box-archive"></i> Source:</label>
          <select id="obtainability-filter"><option value="all">All</option></select>
        </div>
        <div class="control-group filter-group">
          <label for="sort-by"><i class="fa-solid fa-sort"></i> Sort:</label>
          <select id="sort-by">
            <option value="rarity">Rarity</option>
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="value_desc">Value (High-Low)</option>
            <option value="value_asc">Value (Low-High)</option>   
          </select>
        </div>
        <button id="advanced-filters-btn" class="control-button">
          <i class="fa-solid fa-sliders"></i> Advanced
        </button>
        <div class="control-group action-group">
          <button id="clear-filters" class="control-button" disabled>
            <i class="fa-solid fa-filter-circle-xmark"></i> Clear
          </button>
          
          <button id="favorites-button" class="control-button" disabled>
            <i class="fa-solid fa-star"></i> Favorites (<span id="favorites-count">0</span>)
          </button>
        </div>
      </div>
      <div id="item-grid" class="item-grid">
        <div class="loading-indicator">Initializing Database... <i class="fa-solid fa-spinner fa-spin"></i></div>
      </div>
    </section>

    <!-- Section: Guide -->
    <section id="guide" class="content-section">
      <h2><i class="fa-solid fa-book-open"></i> Guide: Understanding Market Dynamics</h2>
      <div class="codex-container">
        <div class="codex-entry">
          <h3><i class="fa-solid fa-chart-line codex-icon stability-icon"></i> Stability Metrics</h3>
          <div id="stability-guide" class="guide-content">
            <div class="loading-indicator">Loading Definitions...</div>
          </div>
        </div>
        <div class="codex-entry">
          <h3><i class="fa-solid fa-fire codex-icon demand-icon"></i> Demand Indicators</h3>
          <div id="demand-guide" class="guide-content">
            <div class="loading-indicator">Loading Definitions...</div>
          </div>
        </div>
        <div class="codex-entry">
          <h3><i class="fa-solid fa-tags codex-icon value-icon"></i> Value Notations</h3>
          <div id="value-guide" class="guide-content">
            <div class="loading-indicator">Loading Definitions...</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section: Update Log - Updated structure -->
    <section id="update-log" class="content-section">
      <h2><i class="fa-solid fa-timeline"></i> Update Log: Value History</h2>
      <div class="timeline-container">
        <div class="timeline-line"></div>
        <div id="timeline-events">
          <div class="loading-indicator">Loading History... <i class="fa-solid fa-spinner fa-spin"></i></div>
          <!-- Hidden example timeline event with properly formatted structure -->
          <div class="timeline-event" style="display: none">
            <span class="event-date">Example Event</span>
            <div class="event-changes-container">
              <div class="event-change increase">
                <strong class="timeline-item-link" data-item-id="example-item" data-rarity="Unique" style="--rarity-color: var(--rarity-unique);">
                  <i class="fa-solid fa-gem"></i> Check V:
                </strong>
                <div class="change-details">
                  <span class="value-difference increase">+20,000</span>
                  <span class="value-range">120,000 → 140,000</span>
                  <span class="value-percentage increase">16%</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Comparison Overlay -->
    <div id="compare-overlay" class="modal-overlay">
      <div class="modal-content compare-content">
        <button id="close-compare" class="close-modal-btn"><i class="fa-solid fa-xmark"></i></button>
        <h2><i class="fa-solid fa-balance-scale"></i> Item Comparison</h2>
        <div id="compare-items-container"></div>
      </div>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Advanced Filters Overlay -->
    <div id="advanced-filter-overlay" class="modal-overlay">
      <div class="modal-content advanced-filter-content">
        <button class="close-modal-btn close-advanced-filters">×</button>
        <h3><i class="fa-solid fa-sliders"></i> Advanced Filters</h3>
        <div class="advanced-filter-groups">
          <fieldset>
            <legend>Sources (Obtainability)</legend>
            <div id="adv-obtain-filters" class="checkbox-group">
              <p class="loading-indicator">Loading sources...</p>
            </div>
          </fieldset>
          <fieldset>
            <legend>Demand</legend>
            <div id="adv-demand-filters" class="checkbox-group">
              <label><input type="checkbox" name="adv-demand" value="High"> High</label>
              <label><input type="checkbox" name="adv-demand" value="Medium"> Medium</label>
              <label><input type="checkbox" name="adv-demand" value="Normal"> Normal</label>
              <label><input type="checkbox" name="adv-demand" value="Low"> Low</label>
              <label><input type="checkbox" name="adv-demand" value="N/A"> N/A</label>
            </div>
          </fieldset>
          <fieldset>
            <legend>Stability</legend>
            <div id="adv-stability-filters" class="checkbox-group">
              <label><input type="checkbox" name="adv-stability" value="Rising"> Rising</label>
              <label><input type="checkbox" name="adv-stability" value="Stable"> Stable</label>
              <label><input type="checkbox" name="adv-stability" value="Unstable"> Unstable</label>
              <label><input type="checkbox" name="adv-stability" value="Declining"> Declining</label>
              <label><input type="checkbox" name="adv-stability" value="N/A"> N/A</label>
            </div>
          </fieldset>
        </div>
        <div class="modal-actions">
          <button id="reset-advanced-filters" class="control-button reset-btn">
            <i class="fa-solid fa-arrow-rotate-left"></i> Reset
          </button>
          <button id="apply-advanced-filters" class="control-button apply-btn">
            <i class="fa-solid fa-check"></i> Apply Filters
          </button>
          <button id="cancel-advanced-filters" class="control-button cancel-btn close-advanced-filters">
            <i class="fa-solid fa-xmark"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Favorites Overlay -->
    <div id="favorites-overlay" class="modal-overlay">
      <div class="modal-content favorites-content">
        <button id="close-favorites" class="close-modal-btn"><i class="fa-solid fa-xmark"></i></button>
        <h2><i class="fa-solid fa-star"></i> Favorites</h2>
        <div class="favorites-actions">
          <button id="clear-favorites-btn" class="control-button danger-btn">
            <i class="fa-solid fa-trash-can"></i> Clear All Favorites
          </button>
        </div>
        <div id="favorites-items-container" class="favorites-items-container"></div>
      </div>
    </div>

    <!-- Confirmation Dialog Modal -->
    <div id="confirmation-modal" class="modal-overlay confirmation-overlay">
      <div class="modal-content confirmation-content">
        <div class="confirmation-icon">
          <i class="fa-solid fa-trash-can"></i>
        </div>
        <h3>Clear All Favorites?</h3>
        <p>This action will remove all items from your favorites collection. This cannot be undone.</p>
        <div class="confirmation-actions">
          <button id="cancel-confirm-btn" class="control-button cancel-btn">
            <i class="fa-solid fa-xmark"></i> Cancel
          </button>
          <button id="confirm-action-btn" class="control-button confirm-btn">
            <i class="fa-solid fa-check"></i> Yes, Clear All
          </button>
        </div>
      </div>
    </div>

    <!-- Item Detail Modal -->
    <div id="item-detail-modal" class="modal-overlay item-detail-overlay">
      <div class="modal-content item-detail-content">
        <button class="close-modal-btn close-item-detail">×</button>
        <div id="item-detail-card-container">
          <div class="loading-indicator">Loading Item Details...</div>
        </div>
      </div>
    </div>

  </main>

  <!-- Footer Element -->
  <footer id="main-footer">
    <p>Data sourced from the KATX Community | Site Design by ULM Labs | Disclaimer: This is a community effort and NOT official.</p>
    <div class="footer-links">
      <a href="#" target="_blank" rel="noopener noreferrer">Game Link (Placeholder)</a> | 
      <a href="#" target="_blank" rel="noopener noreferrer">Discord (Placeholder)</a>
    </div>
  </footer>

  <script src="script.js"></script>
  <!-- Add event listener script to handle mobile timeline accordion behavior -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Handle click events on timeline event dates for mobile
      document.addEventListener('click', function(e) {
        // Only do this on mobile viewport
        if (window.innerWidth <= 768) {
          const timelineEvent = e.target.closest('.timeline-event');
          if (timelineEvent) {
            // Toggle expanded class to show/hide content
            timelineEvent.classList.toggle('expanded');
            
            // Wrap change elements in a container if needed
            if (!timelineEvent.querySelector('.event-changes-container')) {
              const dateEl = timelineEvent.querySelector('.event-date');
              const container = document.createElement('div');
              container.className = 'event-changes-container';
              
              // Move all change elements into the container
              Array.from(timelineEvent.children).forEach(child => {
                if (!child.classList.contains('event-date')) {
                  container.appendChild(child);
                }
              });
              
              timelineEvent.appendChild(container);
            }
          }
        }
      });

      // Add reload handler for viewport changes
      let lastWidth = window.innerWidth;
      const mobileBreakpoint = 768;
      
      window.addEventListener('resize', function() {
        const currentWidth = window.innerWidth;
        // Only trigger if crossing the mobile breakpoint
        if ((lastWidth <= mobileBreakpoint && currentWidth > mobileBreakpoint) ||
            (lastWidth > mobileBreakpoint && currentWidth <= mobileBreakpoint)) {
          // We've crossed the breakpoint - handle the change
          if (typeof handleResponsiveView === 'function') {
            handleResponsiveView();
          }
        }
        lastWidth = currentWidth;
      });
    });
  </script>
</body>
</html>